import md5 from"/js/libraries/md5.js";import{elementFromString,stringToArrayBuffer,arrayBufferToString,readFileAsArrayBuffer}from"/js/functions.js";const DATABASE_VERSION=11;export default function initializeStorageManager(){return new Promise(t=>{const l={getAllTutorialData(){return d("TutorialData","readonly",e=>e.getAll())},getTutorialData(t){return d("TutorialData","readonly",e=>e.get(t))},setTutorialData(t){return d("TutorialData","readwrite",e=>e.put(t))},deleteTutorialData(t){return d("TutorialData","readwrite",e=>e.delete(t))},async getTutorialProgress(t){return await d("TutorialProgressData","readonly",e=>e.get(t))||{progressPercent:0,state:"incomplete",completedOnce:!1}},async setTutorialProgress(e,{progressPercent:t,state:r,completedOnce:a}){var o=await l.getTutorialProgress(e),i=o.progressPercent,n=o.state,o=o.completedOnce;const s={id:e,progressPercent:void 0===t?void 0===i?0:i:t,state:void 0===r?void 0===n?"incomplete":n:r,completedOnce:void 0===a?void 0!==o&&o:a};return d("TutorialProgressData","readwrite",e=>e.put(s))},deleteTutorialProgress(t){return d("TutorialProgressData","readwrite",e=>e.delete(t))},getAllProjectKeys(){return d("ProjectData","readonly",e=>e.getAllKeys())},getProjectData(t){return d("ProjectData","readonly",e=>e.get(t))},setProjectData(t){return d("ProjectData","readwrite",e=>e.put(t))},deleteProjectData(t){return d("ProjectData","readwrite",e=>e.delete(t))},getEditorSettings(){return d("EditorSettings","readonly",e=>e.getAll())},modifyEditorSetting(t){return d("EditorSettings","readwrite",e=>e.put(t))},deleteEditorSetting(t){return d("EditorSettings","readwrite",e=>e.delete(t))},async saveToFile(){var e={};for(const a of["TutorialData","TutorialProgressData","ProjectData","EditorSettings"])e[a]=await d(a,"readonly",e=>e.getAll());var t=JSON.stringify(e),t=stringToArrayBuffer(md5(md5(t))+"|"+t,"utf-8"),t=r()+arrayBufferToString(t,"binary")+r(),t=URL.createObjectURL(new Blob([stringToArrayBuffer(t,"binary")])),t=elementFromString(`<a href="${t}" download="Learn2Code-Save-File-${(new Date).toLocaleDateString()}.L2CSF"></a>`);function r(){return Math.floor(16*Math.random()).toString(2)}document.body.append(t),t.click(),t.remove()},async loadFromFile(){var e=await(async()=>{for(const e of["TutorialData","TutorialProgressData","ProjectData","EditorSettings"])if((await d(e,"readonly",e=>e.getAll())).length)return!0})();if(!e||await confirmCustom("Are you sure you would like to load an existing save?<br><br>You have existing data that will be replaced.")){const i=elementFromString('<input type="file" accept=".L2CSF">');i.addEventListener("change",async()=>{var e=await readFileAsArrayBuffer(i.files[0]),e=(i.remove(),arrayBufferToString(e,"binary").slice(4,-4)),[e,t]=arrayBufferToString(stringToArrayBuffer(e,"binary"),"utf-8").split("|");if(md5(md5(t))!==e)return alertCustom("Error: Could not load save file. It has been modified or corrupt.");try{var r=JSON.parse(t);for(const a in r){await d(a,"readwrite",e=>e.clear());for(const o of r[a])d(a,"readwrite",e=>e.add(o))}await alertCustom("Save file loaded successfully."),window.location.reload()}catch{return alertCustom("Error: Could not load save file. It has been modified or corrupt.")}}),document.body.append(i),i.click()}}};var e=indexedDB.open("UserFiles",DATABASE_VERSION);let s,r=!1;function d(o,i,n){return new Promise(t=>{try{var e=s.transaction(o,i),r=(e.onerror=e=>console.log(e),e.objectStore(o)),a=n(r);a&&(a.onsuccess=e=>t(e.target.result))}catch(e){console.log(e),setTimeout(()=>window.location.reload(),1e3)}})}e.addEventListener("success",e=>{r=!0,s=e.target.result,t(l)}),e.addEventListener("error",e=>console.log(e)),e.addEventListener("upgradeneeded",e=>{(s=e.target.result).objectStoreNames.contains("ProjectData")||s.createObjectStore("ProjectData",{keyPath:"name"}),s.objectStoreNames.contains("TutorialData")||s.createObjectStore("TutorialData",{keyPath:"id"}),s.objectStoreNames.contains("TutorialProgressData")||s.createObjectStore("TutorialProgressData",{keyPath:"id"}),s.objectStoreNames.contains("EditorSettings")||s.createObjectStore("EditorSettings",{keyPath:"name"}),t(l)}),setTimeout(()=>{r||alertCustom("The website needs an update. Close all other instances of this page and reload.")},2e3)})}