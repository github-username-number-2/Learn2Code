import mime from"/js/libraries/mime.js";import{elementFromString,isValidUTF8,stringToArrayBuffer,arrayBufferToString,checkCharacterValid,readFileAsArrayBuffer}from"/js/functions.js";export default async function createFileSystemManager(){const n=document.getElementById("filesContainerInner");new ResizeObserver(D).observe(n),document.getElementById("newFileButton").addEventListener("click",()=>r("file")),document.getElementById("newFolderButton").addEventListener("click",()=>r("folder")),document.getElementById("importFilesButton").addEventListener("click",async function(){const I=await confirmCustom("Upload files or upload a folder?",{confirmText:"Files",cancelText:"Folder"}),E=elementFromString(`<input type="file" ${I?"multiple":"webkitdirectory"}>`);E.addEventListener("change",async()=>{var t=[],i=new Set;let o=S["activePath"];var e,r=S["activeItem"];S.isItemDirectory(r,o)&&(o=(o+" "+r).trim());for(const h of E.files){let e=o;var n=(I?h.name:h.webkitRelativePath).split("/"),a=n.pop().replaceAll(" ","");for(const y of n)e+=" "+y.replaceAll(/[^a-zA-Z0-9._-]/g,""),i.add(e);t.push([e+" "+a,await readFileAsArrayBuffer(h)])}for(const p of i){var[s,l]=A(p),c=S.selectItem(s,l);c&&!await confirmCustom(`Folder "<strong>${l.replaceAll(" ","/").substring(4)}/${s}</strong>" already exists. Would you like to overwrite it?<br><br>If overwritten, all contents will be deleted, else, the folder will not be uploaded.`,{confirmText:"Overwrite contents",cancelText:"Keep contents"})||(c&&S.removeItem(s,l),S.addItem(s,{},l))}for(const v of t){var[d,m]=v,[f,g]=A(d),u=S.selectItem(f,g);u&&!await confirmCustom(`File "<strong>${g.replaceAll(" ","/").substring(4)}/${f}</strong>" already exists. Would you like to overwrite it?<br><br>If overwritten, all contents will be deleted, else, the file will not be uploaded.`,{confirmText:"Overwrite contents",cancelText:"Keep contents"})||(u&&S.removeItem(f,d),u=isValidUTF8(m)?"utf-8":"base64",S.addItem(f,[arrayBufferToString(m,u),u],g))}"root"!==o&&([r,e]=A(o),r=S.selectItem(r,e),S.toggleDirectory(r),"0"===S.getDirectoryState(r)&&S.toggleDirectory(r))}),document.body.append(E),E.click()}),document.getElementById("exportFilesButton").addEventListener("click",function(){alertCustom("This feature is currently a work in progress")});var e=document.getElementById("codeContainer");const h=monaco.editor.create(e,{readOnly:!0,fontSize:userSettings.editorFontSize,lineNumbers:userSettings.editorLineNumbers?"on":"off",wordWrap:userSettings.editorWrapText?"on":"off"}),y=monaco.editor.createModel("no files currently open","plaintext",monaco.Uri.file("root"));h.setModel(y);let t;h.onDidChangeModelContent(()=>{Object.values(S.fileSystemChangeListeners).forEach(e=>e("edit")),clearTimeout(t),t=setTimeout(()=>{F(h.getModel(),S.activeFileEncodingScheme,S.activeFileEncodingSchemeDisplay),webCodeExecutor.executeFilesList(fileSystemManager.getBinaryFilesList(),()=>{})},250)}),h.onDidChangeCursorPosition(e=>{var t=monaco.editor.getModel(monaco.Uri.file(S.activePath+" "+S.activeFile));t&&(t.cursorPosition=e.position)});const i=h.getContribution("editor.contrib.messageController"),v=(h.onDidAttemptReadOnlyEdit(()=>{""===S.activeFile?i.showMessage("Click on a file to edit it.",h.getPosition()):i.showMessage("This file cannot be edited as it is read-only.",h.getPosition())}),await(await fetch("/data/iconData.json")).json());var o=new Set;o.add(`icons/languageIcons/${v.default[0]}.svg`),o.add("icons/folderOpen.png"),o.add("icons/folderClosed.png");for(const s in v.mappings)o.add(`icons/languageIcons/${v.mappings[s][0]}.svg`);const I={},p=(await Promise.all([...o].map(async e=>{var i;I[e]=(i="/images/"+e,await new Promise(e=>{const t=new Image;t.onload=()=>e(t),t.src=i}))})),elementFromString('<div id="tutorialDifferenceEditorContainer"></div>')),E=(p.classList.add("tutorialDifferenceEditorContainerHidden"),e.append(p),monaco.editor.createDiffEditor(p,{enableSplitViewResizing:!1,renderSideBySide:{sideBySide:!0,inline:!1}[userSettings.tutorialDifferenceEditorStyle],fontSize:userSettings.editorFontSize,lineNumbers:userSettings.editorLineNumbers?"on":"off",wordWrap:userSettings.editorWrapText?"on":"off"})),b=monaco.editor.createDiffNavigator(E);let C;const S={editor:h,tutorialDifferenceEditor:E,activeFile:"",activeFilePath:"",activeFileEncodingScheme:"",activeFileEncodingSchemeDisplay:"",activeItem:"root",activePath:"",fileSystemChangeListeners:{},loadFileSystem(e){h.setModel(y),h.updateOptions({readOnly:!0}),C={root:{}},this.activeFile="",this.activeFilePath="",this.activeFileEncodingScheme="",this.activeFileEncodingSchemeDisplay="",this.activeItem="root",this.activePath="",n.innerHTML='<div id="fileSystemRoot" data-path="" data-name="root" data-is-directory="1" data-directory-state="1"></div>';for(const t of monaco.editor.getModels())t!==y&&t.dispose();for(const i in e)this.addItem(i,e[i],"root")},selectItem(e,t){return n.querySelector(`div[data-name="${e}"][data-path="${t}"]`)},getImmediateWithinDirectory(e){return n.querySelectorAll(`div[data-path="${e}"]`)},getAllWithinDirectory(e){return n.querySelectorAll(`div[data-path^="${e}"]`)},getItemName(e){return e.getAttribute("data-name")},addItem(t,e,i){const o=!Array.isArray(e);var[r,e]=o?[e]:e,[n,a]=A(i),s=this.selectItem(n,a);const l=a.length?a+" "+n:n,c=i.split(" ").length,d=elementFromString(`
				<div class="file" data-path="${l}">
					<canvas class="fileIcon"></canvas>
					<p class="fileText"></p>
					<img class="fileOption fileDelete" src="/images/icons/deleteIcon.png">
					<img class="fileOption fileRename" src="/images/icons/renameIcon.png">
				</div>
			`);d.setAttribute("data-name",t),d.style.display=c-1?"none":"block";var[a,n,i,m]=d.children,{width:f,height:g}=(a.width=100,a.height=100,a),n=(a.style.left=2.5*c+"vh",n.innerText=t,n.style.marginLeft=2.5*c+"vh",i.addEventListener("click",async e=>{e.stopPropagation(),await confirmCustom(`Delete "${t}" and all of its contents?`)&&S.removeItem(t,l)}),m.addEventListener("click",async e=>{e.stopPropagation();e=await promptCustom("Enter new name:",{defaultValue:t});null!==e&&w(e,l,o?"folder":"file")&&S.changeItemName(e,t,l)}),a.getContext("2d"));let u=C;for(const h of l.split(" "))u=u[h];u[t]=o?{}:e;i=function(e){var t=[],i=[];for(const r in e){var o=e[r];("string"==typeof o?t:i).push([r,o])}return[...i.sort(),...t.sort()]}(u).findIndex(e=>e[0]===t);if([s,...[...this.getImmediateWithinDirectory(l)].map(e=>{var t,i;return e.getAttribute("data-is-directory")?(t=e.getAttribute("data-name"),i=e.getAttribute("data-path"),(i=[e,...S.getAllWithinDirectory(i+" "+t)])[i.length-1]):e})][i].after(d),d.addEventListener("click",()=>this.setActiveItem(d)),o){d.addEventListener("click",()=>this.toggleDirectory(d)),d.setAttribute("data-directory-state","0"),d.setAttribute("data-is-directory","1"),n.drawImage(I["icons/folderClosed.png"],0,0,f,g);for(const y in r)this.addItem(y,r[y],l+" "+t)}else{a=(m=t).substring(m.indexOf("."));s=m=v.mappings[m]||v.mappings[a]||v.default;n.drawImage(I[`icons/languageIcons/${s[0]}.svg`],0,0,f,g),n.globalCompositeOperation="source-in",n.fillStyle=s[1],n.fillRect(0,0,f,g),monaco.editor.createModel(r,"utf-8"===e?void 0:"plaintext",monaco.Uri.file(l+" "+t))}D();for(const p of Object.values(this.fileSystemChangeListeners))p("addItem")},removeItem(e,t){var i=this.selectItem(e,t),o=(e,t,i)=>{(this.activeItem===t&&this.activePath===e||this.activeFilePath+" "+this.activeFile==e+" "+t)&&this.setActiveItem(document.getElementById("fileSystemRoot")),i.remove()};if(i.getAttribute("data-is-directory"))for(const s of this.getAllWithinDirectory(t+" "+e)){var r=s.getAttribute("data-path"),n=s.getAttribute("data-name");s.getAttribute("data-is-directory")||monaco.editor.getModel(monaco.Uri.file(r+" "+n)).dispose(),o(r,n,s)}else monaco.editor.getModel(monaco.Uri.file(t+" "+e)).dispose();o(t,e,i);let a=C;for(const l of t.split(" "))a=a[l];delete a[e];for(const c of Object.values(this.fileSystemChangeListeners))c("removeItem")},changeItemName(e,t,i){let o=C;for(const n of i.split(" "))o=o[n];var r=o[t],r="string"==typeof r?[this.getFileContents(i,t),r]:a(r,i+" "+t);this.removeItem(t,i),this.addItem(e,r,i),"root"!=i&&([t,r]=A(i),t=S.selectItem(t,r),S.toggleDirectory(t),"0"===S.getDirectoryState(t)&&S.toggleDirectory(t)),D(),this.setActiveItem(this.selectItem(e,i))},moveItem(e,t,i){let o=C;for(const n of i.split(" "))o=o[n];var r=o[t],r="string"==typeof r?[this.getFileContents(i,t),r]:a(r,i+" "+t);this.removeItem(t,i),this.addItem(t,r,e)},setActiveItem(t){if(t===document.getElementById("fileSystemRoot")){this.activeFile="",this.activeFilePath="",this.activeFileEncodingScheme="",this.activeFileEncodingSchemeDisplay="",h.setModel(y),h.updateOptions({readOnly:!0});for(const e of document.getElementsByClassName("editorTab"))e.style.display="none";for(const l of document.getElementsByClassName("fileInfoElement"))l.style.display="none"}var i=t.getAttribute("data-name"),o=t.getAttribute("data-path");if(this.activePath!==o||this.activeItem!==i){window.tutorial&&p.classList.add("tutorialDifferenceEditorContainerHidden"),document.getElementById("editorTabFileName").click();for(const c of document.getElementsByClassName("file"))c.style.backgroundColor=null;t.style.backgroundColor="#dddddd";let e=C;for(const d of o.split(" "))e=e[d];if(this.activeItem=i,this.activePath=o,!t.getAttribute("data-is-directory")){for(const m of document.getElementsByClassName("file"))m.children[1].style.fontWeight=null;t.children[1].style.fontWeight="600",this.activeFile=i,this.activeFilePath=o;var r=this.getFileEncodingScheme(o,i),n=document.getElementById("fileOptionEncodingContainer"),a=document.querySelector(`.fileEncodingOption[data-value="${r}"]`).innerText;this.activeFileEncodingScheme=r,this.activeFileEncodingSchemeDisplay=a;for(const f of document.getElementsByClassName("fileEncodingOption"))f.style.display=f.getAttribute("data-value")===r?"none":"block";n=n.firstElementChild;n.nextElementSibling.after(document.querySelector(`.fileEncodingOption[data-value="${r}"`)),n.innerText="Encoding: "+a;for(const g of document.getElementsByClassName("editorTab"))g.style.display="block";document.getElementById("editorTabFileName").children[0].innerText=o.replaceAll(" ","/").substring(4)+"/"+i;for(const u of document.getElementsByClassName("fileInfoElement"))u.style.display="block";n=monaco.editor.getModel(monaco.Uri.file(o+" "+i));if(h.setModel(n),h.focus(),n.cursorPosition&&h.setPosition(n.cursorPosition),h.updateOptions({readOnly:t.getAttribute("data-is-readonly")}),F(n,r,a),window.tutorial){var s,t=o+" "+i;if(t in this.fileDifferenceEditors){E.setModel({original:this.fileDifferenceEditors[t][0],modified:n}),E.focus(),b.next();const p=document.getElementById("tutorialDifferenceEditorContainer");p.classList.remove("tutorialDifferenceEditorContainerHidden")}o=n,i=r,t=a,n=o._associatedResource.path.substring(1);n in S.fileDifferenceEditors&&(a=monaco.editor.getModelMarkers().filter(e=>"tutorialEncodingWarnings"!==e.owner&&e.resource.path==="/"+S.activeFilePath),n=S.fileDifferenceEditors[n][1],s=document.querySelector(`.fileEncodingOption[data-value="${n}"]`).innerText,n!==i&&(n=o.getLineCount(),a.push({message:`File encoding should be set to ${s}, current encoding is `+t,severity:monaco.MarkerSeverity.Error,startLineNumber:0,startColumn:0,endLineNumber:n,endColumn:o.getLineContent(n).length+1})),monaco.editor.setModelMarkers(o,"tutorialEncodingWarnings",a))}}}},toggleDirectory(e){var t=!parseInt(e.getAttribute("data-directory-state")),i=e.getAttribute("data-name"),o=e.getAttribute("data-path");for(const l of t?this.getImmediateWithinDirectory(o+" "+i):this.getAllWithinDirectory(o+" "+i))if(t)l.style.display="block";else if(l.style.display="none",l.getAttribute("data-is-directory")){const r=l.children[0],{width:n,height:a}=r,s=r.getContext("2d");s.clearRect(0,0,n,a),s.drawImage(I["icons/folderClosed.png"],0,0,n,a),l.setAttribute("data-directory-state","0")}const r=e.children[0],{width:n,height:a}=r,s=r.getContext("2d");s.clearRect(0,0,n,a),s.drawImage(I[t?"icons/folderOpen.png":"icons/folderClosed.png"],0,0,n,a),e.setAttribute("data-directory-state",t?1:0)},isItemDirectory(e,t){return Boolean(this.selectItem(e,t).getAttribute("data-is-directory"))},getDirectoryState(e){return e.getAttribute("data-directory-state")},getFileContents(e,t){var i,o=monaco.editor.getModel(monaco.Uri.file(e+" "+t));return o?(o=o.getValue(),i=this.getFileEncodingScheme(e,t),(o=[...o].filter(e=>checkCharacterValid(e,i))).join("")):null},setFileContents(e,t,i){monaco.editor.getModel(monaco.Uri.file(e+" "+t)).setValue(i)},getFileEncodingScheme(e,t){let i=C;for(const o of e.split(" "))i=i[o];return i[t]},async changeFileEncodingScheme(e,t,i){var o=this.getFileEncodingScheme(e,t);if(o!==i){o=stringToArrayBuffer(this.getFileContents(e,t),o);if("utf-8"===i&&!isValidUTF8(o)&&!await confirmCustom("This file is not valid UTF-8. Encoding it as UTF-8 will change its contents.<br><br>Would you like to proceed?"))return!1;this.removeItem(t,e),this.addItem(t,[arrayBufferToString(o,i),i],e),this.setActiveItem(this.selectItem(t,e))}return!0},getFileSystem(){const n=e=>{var t={};let i=C;for(const o of e.split(" "))i=i[o];for(const r in i)"string"==typeof i[r]?t[r]=[this.getFileContents(e,r),this.getFileEncodingScheme(e,r)]:t[r]=n(e+" "+r);return t};return n("root")},getBinaryFilesList(){return function e(t,i=""){const o=[];for(const r in t){const n=t[r];Array.isArray(n)?o.push([(i+" "+r).trim(),stringToArrayBuffer(...n),mime.getType(r)||"text/plain"]):o.push(...e(n,(i+" "+r).trim()))}return o}(this.getFileSystem())},setFileReadOnly(e,t,i){var o=this.selectItem(t,e);i?o.setAttribute("data-is-readonly","1"):o.removeAttribute("data-is-readonly"),this.activeFile===t&&this.activeFilePath===e&&h.updateOptions({readOnly:!0})},fileDifferenceEditors:{},setFileCorrectState(e,t,i){this.selectItem(t,e).children[1].style.color=i?"#00aa00":"#000000"},showFileHint(e,t,i){i=[monaco.editor.createModel(i[0],void 0,monaco.Uri.file(Math.random()+t)),i[1]],this.fileDifferenceEditors[e+" "+t]=i,e.split(" ").reduce((e,t)=>{return S.selectItem(t,e)&&S.isItemDirectory(t,e)||S.addItem(t,{},e),e+" "+t}),this.selectItem(t,e)?this.isItemDirectory(t,e)&&(this.removeItem(t,e),this.addItem(t,["",i[1]])):this.addItem(t,["",i[1]],e);for(const o of n.querySelectorAll('.file[data-is-directory="1"][data-directory-state="1"]'))this.toggleDirectory(o);for(const r of n.querySelectorAll('.file[data-is-directory="1"]'))this.toggleDirectory(r);t=this.activeItem,i=this.activePath;this.setActiveItem(document.getElementById("fileSystemRoot")),this.setActiveItem(this.selectItem(t,i))},clearFileHints(){p.classList.add("tutorialDifferenceEditorContainerHidden");for(const e of Object.values(this.fileDifferenceEditors))e[0].dispose();this.fileDifferenceEditors={}}};return S;async function r(e){let t=S.activePath;var i=S.activeItem,i=(S.isItemDirectory(i,t)&&(t=(t+" "+i).trim()),await promptCustom(`New ${e} name:`));null!==i&&w(i,t,e)&&(S.addItem(i,{file:["","utf-8"],folder:{}}[e],t),"root"!==t&&([i,e]=A(t),i=S.selectItem(i,e),S.toggleDirectory(i),"0"===S.getDirectoryState(i)&&S.toggleDirectory(i)))}function a(e,t){var[i,o]=A(t);if("string"==typeof e)return[S.getFileContents(o,i),S.getFileEncodingScheme(o,i)];for(const r in e)e[r]=a(e[r],t+" "+r);return e}function F(t,o,r){var n=monaco.editor.getModelMarkers().filter(e=>"encodingWarnings"!==e.owner&&e.resource.path==="/"+S.activeFilePath);for(let i=1,e=t.getLineCount()+1;i<e;i++){var a=[...t.getLineContent(i)];for(let e=0,t=a.length;e<t;e++){var s=a[e];checkCharacterValid(s,o)||n.push({message:`"${s}" is not a valid character within the ${r} encoding scheme. Invalid characters will be ignored.`,severity:monaco.MarkerSeverity.Warning,startLineNumber:i,startColumn:e+1,endLineNumber:i,endColumn:e+2})}}monaco.editor.setModelMarkers(t,"encodingWarnings",n)}function w(e,t,i){t=[...S.getImmediateWithinDirectory(t)].map(e=>S.getItemName(e));if(!e)return alertCustom(i[0].toUpperCase()+i.substring(1)+" names cannot be blank"),0;if(t.includes(e))return alertCustom(`A ${i} in this directory already has the name "${e}"`),0;if(!/^[0-9a-zA-Z._-]+$/.test(e))return alertCustom(i[0].toUpperCase()+i.substring(1)+' names can only contain characters "0-9", "a-z", "A-Z", ".", "_", and "-"'),0;if(e.endsWith("."))return alertCustom(i[0].toUpperCase()+i.substring(1)+' names cannot end with "."'),0;for(const o of Object.getOwnPropertyNames(Object.getPrototypeOf({})))if(e===o)return alertCustom(`${i[0].toUpperCase()+i.substring(1)} names cannot be "${o}". Nice try.`),0;return!["_L2C_RESERVED_INDEX_.html","_L2C_RESERVED_WORKER_.js"].includes(e)||(alertCustom('"_L2C_RESERVED_INDEX_.html" and "_L2C_RESERVED_WORKER_.js" are reserved file names used by the code executor'),0)}function A(e){return[(e=e.split(" ")).pop(),e.join(" ")]}function D(){var e=window.innerWidth/100;let t=0;for(const o of n.children){o.style.width="fit-content";var i=o.getBoundingClientRect().width;i>t&&(t=i)}for(const r of n.children)r.style.width=t+2*e+"px"}}