import mime from"/js/libraries/mime.js";import{elementFromString}from"/js/functions.js";const SHOW_CORRECT_DELAY=60;export default function initializeTutorialFunctions(e){const{id:t,display:i}=e.info,l=elementFromString('<td id="tutorialPanelTab" class="panelTab">Tutorial</td>'),n=elementFromString('<div id="tutorialPanelContent" class="panelContent"><button id="revertFileSystemButton" disabled>Revert File System</button><div id="tutorialPanelText"></div></div>'),o=elementFromString('<div id="tutorialMask"></div>'),a=elementFromString('<button id="tutorialNextButton" class="tutorialButton">Next</button>'),s=elementFromString('<button id="tutorialStartButton" class="tutorialButton">Start</button>');var e=document.getElementById("panelTabContainer").firstElementChild.firstElementChild,r=document.getElementById("panelContentContainer");e.insertBefore(l,e.firstChild),r.insertBefore(n,r.firstChild),document.body.append(o),document.body.append(a),document.body.append(s),document.getElementById("headerText").innerText=document.title="Tutorial: "+i,history.pushState(null,"");const c=document.getElementById("revertFileSystemButton");c.addEventListener("click",async()=>{await confirmCustom("Are you sure you would like to revert the file system back the the last checkpoint?")&&p.revertFileSystem()});let d,u={},m,h=()=>{};fileSystemManager.fileSystemChangeListeners.tutorialChangeListener=e=>{const t=fileSystemManager.activeFile,i=fileSystemManager.activePath;clearTimeout(m),m=setTimeout(()=>{switch(e){case"edit":g(i,t)&&f()&&h();break;case"addItem":case"removeItem":f()&&h()}},600)};const p={resolveOnEvent(i,l){return new Promise(t=>{l.addEventListener(i,function e(){l.removeEventListener(i,e),t()})})},addRequiredFile(e){u["root "+e.replaceAll("/"," ")]=["","utf-8"],f()},setRequiredFileCode(e,t){u["root "+e]=t},appendRequiredFileCode(e,t){var i=u["root "+e][0];u["root "+e][0]=i+t},insertRequiredFileCode(e,t,i,l){e=u["root "+e];e[0]=e[0].split("\n"),e[0].splice(i,l,t),e[0]=e[0].join("\n")},setRequiredFileSystem(e){u={},function e(t,i){for(const l in t){const n=t[l];if(Array.isArray(n)){const o=n[0];u[i+" "+l]=[o,n[1]]}else e(n,i+" "+l)}}(e,"root"),f()},getRequiredFileSystemObject(){var t={};for(const n in u){var i=n.split(" "),l=i.pop();i.shift();let e=t;for(const o of i)e=e[o]=e[o]||{};e[l]=u[n]}return t},resolveOnCodeCorrect(){return new Promise(e=>{h=()=>{fileSystemManager.clearFileHints(),e()},f()&&setTimeout(()=>h(),2e3)})},beginTutorial(){return new Promise(t=>{p.disableInteraction();const i=document.getElementById("tutorialStartButton");i.style.display="block",i.addEventListener("click",function e(){i.removeEventListener("click",e),i.style.display="none",t()})})},async endTutorial(){this.clearAll(),this.displayText(`You have completed the ${i} tutorial. Click the next button to be redirected back to the home page.`),await storageManager.setTutorialProgress(t,{progressPercent:100,state:"complete",completedOnce:!0}),await this.displayNextButton(),window.location.href=`//${window.location.host}/#tutorials`},async loadFileSystem(e){e=await async function e(t){for(const i in t){const l=t[i];Array.isArray(l)?t[i][0]=await l[0]:t[i]=await e(l)}return t}(e),fileSystemManager.loadFileSystem(e),f(),d=JSON.parse(JSON.stringify(e)),c.disabled=!1},async revertFileSystem(){await this.loadFileSystem(d)},displayText(e,t=!1){const i=elementFromString(`
				<div class="tutorialPopup">
					<div class="tutorialPopupHeader">
						<img class="tutorialCollapseButton" src="/images/icons/collapseIcon.png">
						${!0===t?`<p class="tutorialPopupTimer">${SHOW_CORRECT_DELAY}</p>`:""}
					</div>
					<div class="tutorialPopupContent">
						<p>${e.replaceAll("<pre","</p><pre").replaceAll("</pre>","</pre><p>")}</p>
					</div>
				</div>
			`),l=i.querySelector(".tutorialPopupHeader"),n=i.querySelector(".tutorialCollapseButton"),o=i.querySelector(".tutorialPopupTimer"),a=i.querySelector(".tutorialPopupContent");let s=!1;l.addEventListener("click",()=>{s=!s,i.classList.toggle("tutorialPopupCollapsed"),n.classList.toggle("tutorialCollapseButtonCollapsed");for(const e of[...a.children,o,r])e&&(e.style.display=s?"none":"block");i.style.boxShadow={true:"none",false:"0 0 10vh 0.1vh #bbbbbb"}[s],i.contains(r)&&(l.style.width={true:"100%",false:"calc(100% - 14vh)"}[s],l.style.borderTopRightRadius={true:"2vh",false:"0"}[s],n.style.left={true:"50%",false:"calc((100% + 14vh) / 2)"}[s])}),document.body.appendChild(i);const r=document.createElement("button");if(!0===t){let e,t=SHOW_CORRECT_DELAY-1;function c(){d(),e=setInterval(()=>{o.innerText=t,t--<1&&(d(),r.innerText="Show correct code",r.title="Create all required files/folders and show the correct code for each file",r.classList.add("tutorialPopupShowCorrect"),r.addEventListener("click",e=>{e.stopPropagation(),async function(){let e;for(const l in u){var t,i;l in fileSystemManager.fileDifferenceEditors||(t=l.split(" "),[t,i]=[t.slice(0,-1).join(" "),t.slice(-1)[0]],g(t,i)||(e=e||[i,t],fileSystemManager.showFileHint(t,i,u[l])))}e&&fileSystemManager.setActiveItem(fileSystemManager.selectItem(...e))}()}),s?r.style.display="none":(l.style.width="calc(100% - 14vh)",l.style.borderTopRightRadius="0",n.style.left="calc((100% + 14vh) / 2)"),o.remove(),i.append(r))},1e3)}function d(){clearInterval(e)}"visible"===document.visibilityState&&c(),document.addEventListener("visibilitychange",()=>({visible:c,hidden:d})[document.visibilityState]())}},clearText(){for(const e of document.getElementsByClassName("tutorialPopup"))e.remove()},highlightElement(e){const t=document.querySelector(e),i=document.createElement("div");i.classList.add("tutorialHighlighter"),new ResizeObserver(()=>{var e=t.getBoundingClientRect();i.style.left=e.x+"px",i.style.top=e.y+"px",i.style.width=e.width+"px",i.style.height=e.height+"px"}).observe(t),document.body.appendChild(i)},clearHighlighters(){for(const e of document.getElementsByClassName("tutorialHighlighter"))e.remove()},setPanelText(e){document.getElementById("tutorialPanelText").innerHTML=e},displayTextAndSetPanel(e,t=!1){this.displayText(e,t),this.setPanelText(e)},awaitEvent:async e=>{await e()},displayNextButton(){return new Promise(t=>{const i=document.getElementById("tutorialNextButton");i.style.display="block",i.addEventListener("click",function e(){i.removeEventListener("click",e),i.style.display="none",t()})})},clearAll(){this.clearHighlighters(),this.clearText(),this.setPanelText("")},enableInteraction(){o.style.display="none"},disableInteraction(){o.style.display="block"},runFunction(e){e()},highlightAllCode(){for(const e of document.querySelectorAll("[data-lang]"))monaco.editor.colorizeElement(e,e.getAttribute("data-lang"))},createCheckpoint(e){d=fileSystemManager.getFileSystem(),c.disabled=!1,storageManager.setTutorialData({id:t,actionIndex:e,lastCheckPointFileSystem:d,requiredFileSystem:this.getRequiredFileSystemObject()})},async info(e){this.clearAll(),this.enableInteraction(),this.displayText(e),this.highlightAllCode(),await this.displayNextButton()},async infoWithHighlight(e,t){this.clearAll(),this.disableInteraction(),this.highlightElement(t),this.displayText(e),this.highlightAllCode(),await this.displayNextButton()},async instructEventAction(e,t,i){this.clearAll(),this.enableInteraction(),this.displayTextAndSetPanel(e),this.highlightAllCode(),await this.resolveOnEvent(t,i)},async instructCodeAction(e,t,...i){var l=i.pop();this[t](...i),this.clearAll(),this.enableInteraction(),this.displayTextAndSetPanel(e,!0),this.highlightAllCode(),await this.resolveOnCodeCorrect(),this.createCheckpoint(l+1)},async instructCodeExecution(e){this.clearAll(),this.displayTextAndSetPanel(e),await this.resolveOnEvent("click",document.getElementById("runCode"))}};return p;function y(e,t){switch(t){case"text/html":e=html_beautify(e);break;case"text/css":e=css_beautify(e);break;case"application/javascript":e=js_beautify(e)}return e.replaceAll("\r","").split("\n").filter(e=>e).map(e=>e.trim()).join("\n")}function g(t,i){if(!t&&!i)return 1;var l,n,o,a,s=fileSystemManager.getFileContents(t,i);if(null!==s){let e;return e=!!u[t+" "+i]&&([l,n]=u[t+" "+i],o=mime.getType(i)||"text/plain",s=s,a=fileSystemManager.getFileEncodingScheme(t,i),y(l,o)===y(s,o)&&n===a),fileSystemManager.setFileCorrectState(t,i,e),e}}function f(){let e=!0;for(const l in u){var t=l.split(" "),[t,i]=[t.slice(0,-1).join(" "),t.slice(-1)[0]];g(t,i)||(e=!1)}return e}}