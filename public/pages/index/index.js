import initializeStorageManager from"/js/storageManager.js";import{elementFromString}from"/js/functions.js";window.addEventListener("load",async()=>{const e=[...document.getElementsByClassName("subPage")].map(e=>e.id);e.includes(window.location.hash.substring(1))||(window.location.hash="info"),o(window.location.hash.substring(1));for(const n of e.keys()){var t=document.getElementById(e[n]+"Button");t.style.left="calc(11vh + "+12*n+"vw)",t.addEventListener("mousedown",()=>{o(e[n])})}window.storageManager=await initializeStorageManager();{const w=(await import("/data/tutorials/tutorialIndex.js")).default,v=w["tutorialList"],f={},P={};let e=0,t=0,n;const E=document.getElementById("tutorialsContainerInner"),k=document.getElementById("tutorialPreviewTitle"),q=document.getElementById("tutorialPreviewDescription"),_=document.getElementById("tutorialPreviewImage"),z=document.getElementById("tutorialPreviewBack"),R=document.getElementById("tutorialPreviewReset"),W=document.getElementById("tutorialPreviewDelete"),C=document.getElementById("tutorialOpenButtonLink"),j=C.children[0],F=document.getElementById("tutorialPreviewRelatedLinks"),M=document.getElementsByClassName("tutorialPreview");for(const T in v){const $=await storageManager.getTutorialProgress(T),A=v[T];var a=elementFromString(`
					<div id="tutorial_${T}" class="tutorialContainer" style="left: ${A.left}vh; top: ${A.top}vh">
						<div class="difficultyBar"></div>
						<img src="/data/tutorials/resources/${T}/icon.png" alt="${A.display} preview icon">
						<h1>${A.display}</h1>
						<p>${Math.trunc($.progressPercent)}% Complete</p>
						<div class="tutorialMask"></div>
					</div>
				`);E.append(a),a.addEventListener("mousedown",e=>e.stopPropagation()),a.addEventListener("click",()=>{n=T,k.innerText=A.display,q.innerText=A.description,_.src=`/data/tutorials/resources/${T}/icon.png`,C.href=`//${window.location.host}/pages/editor.html#tutorial-`+encodeURIComponent(T);for(const t of document.querySelectorAll(".tutorialPreviewLink"))t.remove();for(const o of A.relatedLinks)F.append(elementFromString(`<a class="tutorialPreviewLink" href="${o}" target="_blank">${o}</a>`));var e=L[T];j.disabled=!e,e?j.removeAttribute("title"):j.title="Complete the previous tutorials to unlock this one.";for(const a of M)a.style.display="block"}),f[T]=A,P[T]=$,e=Math.max(e,A.left),t=Math.max(t,A.top)}const B=document.getElementById("tutorialSpacer"),L=(B.style.left=e+"vh",B.style.top=t+"vh",{});for(const D in P){var r=f[D].prerequisites.every(e=>P[e].completedOnce);L[D]=r,document.getElementById("tutorial_"+D).querySelector(".tutorialMask").style.display=r?"none":null}z.addEventListener("click",()=>{for(const e of M)e.style.display="none"}),R.addEventListener("click",async()=>{await confirmCustom("Are you sure you would like to clear progress for this tutorial?<br><br>All unlocked tutorials will stay unlocked.")&&(await storageManager.setTutorialProgress(n,{progressPercent:0}),await storageManager.deleteTutorialData(n),window.location.reload())}),W.addEventListener("click",async()=>{await confirmCustom("Are you sure you would like to clear all progress for this tutorial?<br><br>Any tutorials requiring this one as a prerequisite will become locked.")&&(await storageManager.deleteTutorialProgress(n),await storageManager.deleteTutorialData(n),window.location.reload())});var i=document.documentElement.clientHeight/50;for(const S of Object.values(f))for(const x of S.prerequisites){var s,l=f[x],c=elementFromString('<canvas class="tutorialPrerequisiteLine" width="300" height="300"></canvas>'),d=c.getContext("2d"),[l,m,u,g]=[S.left,S.top,l.left,l.top],h=Math.abs(l-u),m=m-g-26,p=m*i,g=(c.style.top=g+31+"vh",c.style.height=m+"vh",c.height=p,document.documentElement.clientHeight/150),m=P[x].completedOnce?"#888888":"#555555";h?(c.width=s=h*i,c.style.left=Math.min(l,u)+5+"vh",c.style.width=h+"vh",d.lineWidth=g,d.strokeStyle=m,d.moveTo((h=u<l)?0:s,0),d.lineTo(h?s:0,p)):(c.width=h=2*i,c.style.left=Math.min(l,u)+4+"vh",c.style.width="2vh",d.lineWidth=g,d.strokeStyle=m,d.moveTo(h/2,0),d.lineTo(h/2,p)),d.stroke(),E.append(c)}const b={},I=document.getElementById("tutorials");function y(e){I.scrollLeft=b.x+b.scrollX-e.clientX,I.scrollTop=b.y+b.scrollY-e.clientY}I.addEventListener("mousedown",e=>{b.x=e.clientX,b.y=e.clientY,b.scrollX=I.scrollLeft,b.scrollY=I.scrollTop,I.addEventListener("mousemove",y)}),window.addEventListener("mouseup",()=>I.removeEventListener("mousemove",y));let o=1;I.addEventListener("wheel",e=>{o=Math.min(Math.max(o-e.deltaY/1e3,.2),3),E.style.transform=`scale(${o})`,e.preventDefault()},{passive:!1})}function o(e){for(const o of document.getElementsByClassName("subPageButton"))o.style.height="4.1vh",o.style.backgroundColor="#cccccc",o.children[0].style.marginTop="1vh";for(const a of document.getElementsByClassName("subPage"))a.style.display="none";var t=document.getElementById(e+"Button");t.style.height="4.71vh",t.style.backgroundColor="#eeeeee",t.children[0].style.marginTop="0.8em",document.getElementById(e).style.display="block",window.location.hash=e}await 0,await async function a(){const e=document.getElementById("newProjectButton"),n=document.getElementById("projectsContainer");e.addEventListener("click",async()=>{const e=await promptCustom("Project name:");if(null!==e)return e?/^[0-9a-zA-Z ._-]+$/.test(e)?e.startsWith(" ")||e.endsWith(" ")?alertCustom('Project names can not start or end with " "'):await storageManager.getProjectData(e)?alertCustom("A project with this name already exists"):(storageManager.setProjectData({name:e,fileSystem:{"index.html":["","utf-8"]}}),void(window.location=`//${window.location.host}/pages/editor.html#editor-`+encodeURIComponent(e))):alertCustom('Project names can only contain characters "0-9", "a-z", "A-Z", ".", "_", "-" and " "'):alertCustom("Project names cannot be blank")});const t=await storageManager.getAllProjectKeys();for(const r of t){const o=elementFromString(`
				<div class="project">
					<p>${r}</p>
					<img title="Delete Project" src="/images/icons/deleteIcon.png">
					<img title="Rename Project" src="/images/icons/renameIcon.png">
				</div>
			`);o.addEventListener("click",()=>window.open(`//${window.location.host}/pages/editor.html#editor-`+encodeURIComponent(r))),o.children[1].addEventListener("click",async e=>{if(e.stopPropagation(),await confirmCustom("Are you sure you want to delete this project? This can not be undone.")){const t=await promptCustom("Please type the name of this project to verify this action:");t===r?(storageManager.deleteProjectData(r),n.innerHTML="",a()):null!==t&&alertCustom("Name did not match")}}),o.children[2].addEventListener("click",async e=>{e.stopPropagation();const t=await promptCustom("Enter new project name:",{defaultValue:r});if(null!==t){if(!t)return alertCustom("Project names cannot be blank");if(!/^[0-9a-zA-Z ._-]+$/.test(t))return alertCustom('Project names can only contain characters "0-9", "a-z", "A-Z", ".", "_", "-" and " "');if(t.startsWith(" ")||t.endsWith(" "))return alertCustom('Project names can not start or end with " "');if(t===r)return alertCustom("The name must be different then the current.");if(await storageManager.getProjectData(t))return alertCustom("A project with this name already exists");const o=await storageManager.getProjectData(r);await storageManager.setProjectData({...o,name:t}),await storageManager.deleteProjectData(r),n.innerHTML="",a()}}),n.appendChild(o)}}(),loadPage()});